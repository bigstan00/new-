name: CD
on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  pull_and_run_code:
    runs-on: self-hosted

    steps:
      - name: Stop the container
        run: docker stop test-calc || true

      - name: Remove the container test-calc
        run: docker rm test-calc || true

      - name: Get the code from Docker Hub
        run: docker pull bigstan00/test-image:1

      - name: Run the image as a container
        run: docker run -d -p 3004:3000 --name test-calc bigstan00/test-image:1

      - name: Send Slack message for deployment success
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
           channel-id: 'D078WC91R62'  # Replace with your channel ID
           slack-message: "Deployment succeeded! ðŸŽ‰\n[Commit URL](${{ github.event.workflow_run.head_commit.url }})"
        env:
           SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Send Slack message for deployment failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
           channel-id: 'D078WC91R62'  # Replace with your channel ID
           slack-message: "Deployment failed. ðŸ˜ž\n[Commit URL](${{ github.event.workflow_run.head_commit.url }})"
        env:
           SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  Notification:        
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Send email notification
        env:
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          echo "Subject: GitHub Action Notification" > email.txt
          echo "" >> email.txt
          echo "This is a notification email from GitHub Actions." >> email.txt
          echo "" >> email.txt
          echo "Commit message: ${{ github.event.head_commit.message }}" >> email.txt
          echo "Committer: ${{ github.event.head_commit.committer.name }}" >> email.txt
          echo "Repository: ${{ github.repository }}" >> email.txt
          echo "" >> email.txt
          cat email.txt | sendmail -v -s "smtp.gmail.com:587" -u $EMAIL -p $PASSWORD your-email@example.com
